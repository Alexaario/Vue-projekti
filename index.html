<html>

<head>
    <script src="https://unpkg.com/vue@2.4.3/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
</head>

<body>
    <h1>Keravalta lähtevät junat</h1>
    <div id="trains">
        <div v-for="train in trainsData">
            {{ train[0].toLocaleTimeString("fi-FI") }} | {{ train[1].commuterLineID }}
        </div>
    </div>

    <script language="javascript">
        var vm = new Vue({
            el: "#trains",
            data: {
                trainsData: null,
            },

            methods: {
                getTrainData: async function () {
                    const trainsToGet = 20

                    let trains = [];

                    await axios
                        .get(
                            `https://rata.digitraffic.fi/api/v1/live-trains?arrived_trains=0&arriving_trains=0&departed_trains=0&departing_trains=${trainsToGet}&station=KE`
                        )
                        .then((res) => {
                            trains = res.data;
                        });

                    let departing = [];

                    trains.forEach((departures) => {
                        if (departures.trainCategory !== "Commuter") return;
                        if (departures.commuterLineID === "V") return;
                        if (departures.cancelled === true) return;

                        let trainTimeTable = departures.timeTableRows;

                        trainTimeTable.forEach((departure) => {
                            if (departure.type !== "DEPARTURE") return;
                            if (departure.stationShortCode !== "KE") return;
                            if (departure.cancelled === true) return;


                            let date = new Date(departure.scheduledTime);
                            departing.push([date, departures]);
                        });
                    });

                    console.log("Update");

                    this.trainsData = departing.sort();
                    console.log(departing.sort())
                },
            },

            mounted: async function () {
                this.getTrainData();

                this.timer = setInterval(() => {
                    this.getTrainData();
                }, 10000);
            },
        });
    </script>
</body>

</html>