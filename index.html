<html>
    <head>
        <script src="https://unpkg.com/vue@2.4.3/dist/vue.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    </head>

    <body>
        <div id="trains">
            <div v-for="(train, index) in trainsData">
              <div>{{ train[0] }} {{ train[1].commuterLineID }}</div>
            </div>
        </div>

        <script language="javascript">
            var vm = new Vue({
                el: "#trains",
                data: {
                    trainsData: null,
                },

                methods: {
                    getTrainData: async function () {
                        const trainsToGet = 100

                        let trains = [];

                        await axios
                            .get(
                                `https://rata.digitraffic.fi/api/v1/live-trains?arrived_trains=0&arriving_trains=0&departed_trains=0&departing_trains=${trainsToGet}&station=KE`
                            )
                            .then((res) => {
                                trains = res.data;
                            });

                        let departing = [];

                        trains.forEach((departures) => {
                            if (departures.trainCategory !== "Commuter") return;

                              let trainTimeTable = departures.timeTableRows;

                            trainTimeTable.forEach((departure) => {
                                if (departure.type !== "DEPARTURE") return;
                                if (departure.stationShortCode !== "KE") return;

                                let date = new Date(departure.scheduledTime).toLocaleString("fi-FI");
                                departing.push([date, departures]);
                            });
                        });

                        console.log("Update");

                        this.trainsData = departing.sort();
                    },
                },

                mounted: async function () {
                    this.getTrainData();

                    this.timer = setInterval(() => {
                        this.getTrainData();
                    }, 10000);
                },
            });
        </script>
    </body>
</html>
